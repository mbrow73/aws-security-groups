name: "Validate Security Groups PR"

on:
  pull_request:
    branches: [main]
    paths:
      - 'accounts/**'
      - 'guardrails.yaml'
      - 'prefix-lists.yaml'
      - 'baseline/**'
      - 'modules/**'
      - 'scripts/**'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'

jobs:
  detect-changes:
    name: "Detect Changed Accounts"
    runs-on: ubuntu-latest
    outputs:
      changed-accounts: ${{ steps.detect.outputs.accounts }}
      baseline-changed: ${{ steps.detect.outputs.baseline_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed accounts
        id: detect
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          ACCOUNTS=$(echo "$CHANGED_FILES" | grep -E '^accounts/[0-9]+/' | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
          BASELINE_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -qE '^(baseline/|guardrails\.yaml|prefix-lists\.yaml)'; then
            BASELINE_CHANGED="true"
          fi
          echo "accounts=$ACCOUNTS" >> $GITHUB_OUTPUT
          echo "baseline_changed=$BASELINE_CHANGED" >> $GITHUB_OUTPUT

  validate:
    name: "Validate Security Groups"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-accounts != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml

      - name: Run validation
        id: validate
        run: |
          IFS=',' read -ra ACCOUNTS <<< "${{ needs.detect-changes.outputs.changed-accounts }}"
          EXIT_CODE=0
          VALIDATION_OUTPUT=""
          
          for account in "${ACCOUNTS[@]}"; do
            echo "========================================="
            echo "Validating account: $account"
            echo "========================================="
            
            # Run validation and capture output
            if ACCOUNT_OUTPUT=$(python scripts/validate.py "accounts/$account" --format markdown --no-warnings 2>&1); then
              VALIDATION_OUTPUT="$VALIDATION_OUTPUT$ACCOUNT_OUTPUT"$'\n\n'
            else
              ACCOUNT_EXIT_CODE=$?
              VALIDATION_OUTPUT="$VALIDATION_OUTPUT$ACCOUNT_OUTPUT"$'\n\n'
              if [ $ACCOUNT_EXIT_CODE -eq 1 ]; then
                EXIT_CODE=1  # Errors found
              elif [ $ACCOUNT_EXIT_CODE -eq 2 ] && [ $EXIT_CODE -eq 0 ]; then
                EXIT_CODE=2  # Warnings only
              fi
            fi
          done
          
          # Save validation output for the comment step
          echo "VALIDATION_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$VALIDATION_OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_ENV
          exit $EXIT_CODE

  post-summary:
    name: "Post Validation Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: always() && needs.detect-changes.outputs.changed-accounts != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml
        
      - name: Generate validation summary
        id: generate-summary
        run: |
          IFS=',' read -ra ACCOUNTS <<< "${{ needs.detect-changes.outputs.changed-accounts }}"
          VALIDATION_OUTPUT=""
          
          for account in "${ACCOUNTS[@]}"; do
            # Run validation with markdown output (ignore exit code for summary)
            if ACCOUNT_OUTPUT=$(python scripts/validate.py "accounts/$account" --format markdown --no-warnings 2>/dev/null || true); then
              VALIDATION_OUTPUT="$VALIDATION_OUTPUT$ACCOUNT_OUTPUT"$'\n\n'
            fi
          done
          
          # If no markdown output was generated (all passed), create a success message
          if [ -z "$VALIDATION_OUTPUT" ] || echo "$VALIDATION_OUTPUT" | grep -q "All checks passed"; then
            VALIDATION_OUTPUT="## âœ… Security Group Validation Results"$'\n\n'"**Status:** All schema, guardrails, and naming checks passed!"$'\n\n'"ðŸš€ Once approved and merged, Terraform Cloud will handle deployment."
          fi
          
          # Save to environment variable for the comment step
          echo "VALIDATION_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$VALIDATION_OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            // Delete previous validation comments from this workflow
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            for (const comment of comments.data) {
              if (comment.user.login === 'github-actions[bot]' && 
                  comment.body.includes('Security Group Validation Results')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }
            
            // Post new summary
            const summary = process.env.VALIDATION_SUMMARY;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
