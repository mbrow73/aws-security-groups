name: "Validate Security Groups PR"

on:
  pull_request:
    branches: [main]
    paths:
      - 'accounts/**'
      - 'guardrails.yaml'
      - 'prefix-lists.yaml'
      - 'modules/**'
      - 'scripts/**'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  detect-changes:
    name: "Detect Changed Accounts"
    runs-on: ubuntu-latest
    outputs:
      changed-accounts: ${{ steps.detect.outputs.accounts }}
      has-accounts: ${{ steps.detect.outputs.has_accounts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed accounts
        id: detect
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          ACCOUNTS=$(echo "$CHANGED_FILES" | grep -E '^accounts/[0-9]+/' | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
          
          if [ -n "$ACCOUNTS" ]; then
            echo "accounts=$ACCOUNTS" >> $GITHUB_OUTPUT
            echo "has_accounts=true" >> $GITHUB_OUTPUT
          else
            echo "accounts=" >> $GITHUB_OUTPUT
            echo "has_accounts=false" >> $GITHUB_OUTPUT
          fi

  validate:
    name: "Validate Security Groups"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-accounts == 'true'
    outputs:
      summary: ${{ steps.validate.outputs.summary }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml

      - name: Run validation
        id: validate
        run: |
          IFS=',' read -ra ACCOUNTS <<< "${{ needs.detect-changes.outputs.changed-accounts }}"
          EXIT_CODE=0
          VALIDATION_OUTPUT=""
          
          for account in "${ACCOUNTS[@]}"; do
            echo "========================================="
            echo "Validating account: $account"
            echo "========================================="
            
            ACCOUNT_OUTPUT=$(python scripts/validate.py "accounts/$account" --format markdown 2>&1) || ACCOUNT_EXIT_CODE=$?
            ACCOUNT_EXIT_CODE=${ACCOUNT_EXIT_CODE:-0}
            
            VALIDATION_OUTPUT="${VALIDATION_OUTPUT}${ACCOUNT_OUTPUT}"$'\n\n'
            
            if [ $ACCOUNT_EXIT_CODE -eq 1 ]; then
              EXIT_CODE=1
            elif [ $ACCOUNT_EXIT_CODE -eq 2 ] && [ $EXIT_CODE -eq 0 ]; then
              EXIT_CODE=2
            fi
          done
          
          # If everything passed, generate a success summary
          if [ $EXIT_CODE -eq 0 ]; then
            VALIDATION_OUTPUT="## âœ… Security Group Validation Results"$'\n\n'"**Status:** All schema, guardrails, and naming checks passed!"$'\n\n'"ðŸš€ Once approved and merged, Terraform Cloud will handle deployment."
          fi
          
          # Write summary to file for artifact upload and job output
          echo "$VALIDATION_OUTPUT" > /tmp/validation-summary.md
          
          # Also set as job output (truncated to 1MB GitHub limit)
          {
            echo "summary<<SUMMARY_EOF"
            head -c 1000000 /tmp/validation-summary.md
            echo "SUMMARY_EOF"
          } >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE

      - name: Upload validation summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-summary
          path: /tmp/validation-summary.md
          retention-days: 5

  post-summary:
    name: "Post Validation Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: always() && needs.detect-changes.outputs.has-accounts == 'true'
    steps:
      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            // Get the summary from the validate job output
            const summary = `${{ needs.validate.outputs.summary }}`;
            
            if (!summary || summary.trim() === '') {
              console.log('No validation summary to post');
              return;
            }
            
            // Delete previous validation comments from this workflow
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            for (const comment of comments.data) {
              if (comment.user.login === 'github-actions[bot]' && 
                  comment.body.includes('Security Group Validation Results')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }
            
            // Post new summary
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
