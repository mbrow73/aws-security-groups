name: "Validate Security Groups PR"

on:
  pull_request:
    branches: [main]
    paths:
      - 'accounts/**'
      - 'guardrails.yaml'
      - 'prefix-lists.yaml'
      - 'baseline/**'
      - 'modules/**'
      - 'scripts/**'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'

jobs:
  detect-changes:
    name: "Detect Changed Accounts"
    runs-on: ubuntu-latest
    outputs:
      changed-accounts: ${{ steps.detect.outputs.accounts }}
      baseline-changed: ${{ steps.detect.outputs.baseline_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed accounts
        id: detect
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          ACCOUNTS=$(echo "$CHANGED_FILES" | grep -E '^accounts/[0-9]+/' | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
          BASELINE_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -qE '^(baseline/|guardrails\.yaml|prefix-lists\.yaml)'; then
            BASELINE_CHANGED="true"
          fi
          echo "accounts=$ACCOUNTS" >> $GITHUB_OUTPUT
          echo "baseline_changed=$BASELINE_CHANGED" >> $GITHUB_OUTPUT

  validate:
    name: "Validate Security Groups"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-accounts != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml

      - name: Run validation
        id: validate
        run: |
          IFS=',' read -ra ACCOUNTS <<< "${{ needs.detect-changes.outputs.changed-accounts }}"
          EXIT_CODE=0
          for account in "${ACCOUNTS[@]}"; do
            echo "========================================="
            echo "Validating account: $account"
            echo "========================================="
            python scripts/validate.py "accounts/$account" || EXIT_CODE=$?
          done
          exit $EXIT_CODE

  post-summary:
    name: "Post Validation Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, validate]
    if: always() && needs.detect-changes.outputs.changed-accounts != ''
    steps:
      - name: Post summary
        uses: actions/github-script@v7
        with:
          script: |
            const validateResult = '${{ needs.validate.result }}';
            let summary = '## ðŸ” Validation Summary\n\n';
            if (validateResult === 'success') {
              summary += 'âœ… **Schema, guardrails, and naming checks passed.**\n\n';
              summary += 'ðŸš€ Once approved and merged, Terraform Cloud will handle deployment.\n';
            } else {
              summary += 'âŒ **Validation failed.** Check the workflow logs for details.\n';
            }
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
