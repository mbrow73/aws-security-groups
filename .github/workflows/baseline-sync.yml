name: "Sync Baseline to Opted-In Accounts"

on:
  push:
    branches: [main]
    paths:
      - 'baseline/**'
      - 'prefix-lists.yaml'
      - 'modules/security-group/**'
      - 'modules/vpc-discovery/**'
  
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync baseline to all accounts'
        required: false
        default: 'false'
        type: boolean
      target_accounts:
        description: 'Comma-separated list of account IDs to sync (leave empty for all)'
        required: false
        type: string
      target_profiles:
        description: 'Comma-separated list of profiles to sync (leave empty for all changed profiles)'
        required: false
        type: string

permissions:
  id-token: write   # For OIDC AWS authentication
  contents: read    # For checking out repository
  actions: write    # For workflow dispatch
  issues: write     # For creating issues on failures

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0
  PYTHON_VERSION: '3.11'

jobs:
  detect-changed-profiles:
    name: "Detect Changed Baseline Profiles"
    runs-on: ubuntu-latest
    outputs:
      changed_profiles: ${{ steps.detect.outputs.changed_profiles }}
      affected_accounts: ${{ steps.detect.outputs.affected_accounts }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Detect changed baseline profiles
        id: detect
        run: |
          if [ "${{ github.event.inputs.target_profiles }}" != "" ]; then
            # Manual trigger with specific profiles
            CHANGED_PROFILES="${{ github.event.inputs.target_profiles }}"
            echo "Manual trigger - using specified profiles: $CHANGED_PROFILES"
          else
            # Auto-detect based on changed files
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '^baseline/profiles/|^baseline/prefix-lists\.tf$|^prefix-lists\.yaml$' || true)
            echo "Changed files: $CHANGED_FILES"
            
            CHANGED_PROFILES=""
            if echo "$CHANGED_FILES" | grep -q "baseline/profiles/vpc-endpoints/"; then
              CHANGED_PROFILES="${CHANGED_PROFILES},vpc-endpoints"
            fi
            if echo "$CHANGED_FILES" | grep -q "baseline/profiles/internet-ingress/"; then
              CHANGED_PROFILES="${CHANGED_PROFILES},internet-ingress"
            fi
            if echo "$CHANGED_FILES" | grep -q "baseline/profiles/eks-standard/"; then
              CHANGED_PROFILES="${CHANGED_PROFILES},eks-standard"
            fi
            
            # If prefix lists or main baseline files changed, sync all profiles
            if echo "$CHANGED_FILES" | grep -qE "prefix-lists\.yaml$|baseline/main\.tf$|baseline/variables\.tf$|baseline/outputs\.tf$"; then
              CHANGED_PROFILES="vpc-endpoints,internet-ingress,eks-standard"
              echo "Global baseline files changed - syncing all profiles"
            fi
            
            # Remove leading comma
            CHANGED_PROFILES=$(echo "$CHANGED_PROFILES" | sed 's/^,//')
          fi
          
          if [ -z "$CHANGED_PROFILES" ]; then
            echo "No baseline profile changes detected"
            CHANGED_PROFILES=""
            AFFECTED_ACCOUNTS="[]"
          else
            echo "Changed profiles: $CHANGED_PROFILES"
            
            # Find accounts that use any of the changed profiles
            AFFECTED_ACCOUNTS=$(python3 << 'EOF'
import os
import yaml
import json
from pathlib import Path

changed_profiles = os.environ.get('CHANGED_PROFILES', '').split(',')
changed_profiles = [p.strip() for p in changed_profiles if p.strip()]

affected_accounts = []
accounts_dir = Path('accounts')

if accounts_dir.exists():
    for account_dir in accounts_dir.iterdir():
        if account_dir.is_dir() and account_dir.name != '_example':
            sg_file = account_dir / 'security-groups.yaml'
            if sg_file.exists():
                try:
                    with open(sg_file, 'r') as f:
                        config = yaml.safe_load(f)
                    
                    if config and 'baseline_profiles' in config:
                        account_profiles = config['baseline_profiles']
                        if any(profile in account_profiles for profile in changed_profiles):
                            account_id = config.get('account_id', account_dir.name)
                            affected_accounts.append(str(account_id))
                            print(f"Account {account_id} uses changed profiles: {[p for p in changed_profiles if p in account_profiles]}")
                
                except Exception as e:
                    print(f"Warning: Could not parse {sg_file}: {e}")

print(f"Affected accounts: {affected_accounts}")
print(json.dumps(affected_accounts))
EOF
            )
          fi
          
          echo "changed_profiles=$CHANGED_PROFILES" >> $GITHUB_OUTPUT
          echo "affected_accounts=$AFFECTED_ACCOUNTS" >> $GITHUB_OUTPUT

  validate-baseline:
    name: "Validate Baseline Configuration"
    runs-on: ubuntu-latest
    needs: detect-changed-profiles
    if: needs.detect-changed-profiles.outputs.changed_profiles != ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          
      - name: Terraform Format Check
        run: |
          cd baseline
          terraform fmt -check -recursive
          
      - name: Terraform Validate
        run: |
          cd baseline
          terraform init -backend=false
          terraform validate
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Validate baseline profiles
        run: |
          # Validate that all profile directories have proper structure
          for profile in vpc-endpoints internet-ingress eks-standard; do
            if [ ! -d "baseline/profiles/$profile" ]; then
              echo "‚ùå Missing profile directory: baseline/profiles/$profile"
              exit 1
            fi
            
            for file in main.tf variables.tf outputs.tf; do
              if [ ! -f "baseline/profiles/$profile/$file" ]; then
                echo "‚ùå Missing file: baseline/profiles/$profile/$file"
                exit 1
              fi
            done
            
            echo "‚úÖ Profile $profile has valid structure"
          done
          
      - name: Validate prefix lists configuration
        run: |
          python scripts/validate.py --prefix-lists-only

  sync-baseline:
    name: "Sync Baseline to Account"
    runs-on: ubuntu-latest
    needs: [detect-changed-profiles, validate-baseline]
    if: needs.detect-changed-profiles.outputs.affected_accounts != '[]'
    strategy:
      matrix:
        account: ${{ fromJson(needs.detect-changed-profiles.outputs.affected_accounts) }}
      max-parallel: 5  # Sync to max 5 accounts in parallel
      fail-fast: false  # Continue syncing to other accounts if one fails
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          role-session-name: sg-baseline-sync-${{ matrix.account }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Verify account access
        id: account-access
        run: |
          aws sts get-caller-identity
          CURRENT_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
          echo "Account: $CURRENT_ACCOUNT"
          
          # Verify we can access the target account
          if [ "$CURRENT_ACCOUNT" != "${{ matrix.account }}" ]; then
            echo "‚ùå Cannot access target account ${{ matrix.account }}"
            echo "Currently authenticated to account: $CURRENT_ACCOUNT"
            exit 1
          fi
          
      - name: Load account configuration
        id: config
        run: |
          ACCOUNT_DIR=""
          
          # Look for account directory by account ID or name
          if [ -d "accounts/${{ matrix.account }}" ]; then
            ACCOUNT_DIR="accounts/${{ matrix.account }}"
          else
            # Search for directory containing this account ID in its YAML
            for dir in accounts/*/; do
              if [ -f "${dir}security-groups.yaml" ]; then
                ACCOUNT_ID=$(python3 -c "
import yaml
try:
    with open('${dir}security-groups.yaml', 'r') as f:
        config = yaml.safe_load(f)
    if config and config.get('account_id') == '${{ matrix.account }}':
        print('found')
except:
    pass
")
                if [ "$ACCOUNT_ID" = "found" ]; then
                  ACCOUNT_DIR="$dir"
                  break
                fi
              fi
            done
          fi
          
          if [ -z "$ACCOUNT_DIR" ]; then
            echo "‚ùå Could not find configuration for account ${{ matrix.account }}"
            exit 1
          fi
          
          echo "account_dir=$ACCOUNT_DIR" >> $GITHUB_OUTPUT
          echo "Found configuration in: $ACCOUNT_DIR"
          
          # Extract baseline profiles from account configuration
          BASELINE_PROFILES=$(python3 -c "
import yaml
with open('${ACCOUNT_DIR}security-groups.yaml', 'r') as f:
    config = yaml.safe_load(f)
profiles = config.get('baseline_profiles', [])
print(','.join(profiles) if profiles else '')
")
          
          echo "baseline_profiles=$BASELINE_PROFILES" >> $GITHUB_OUTPUT
          echo "Account baseline profiles: $BASELINE_PROFILES"
          
      - name: Generate Terraform for baseline
        run: |
          # Generate baseline Terraform configuration
          mkdir -p baseline-deployment
          cd baseline-deployment
          
          # Create terraform variables file
          cat > terraform.tfvars << EOF
account_id = "${{ matrix.account }}"
region = "${{ env.AWS_REGION }}"
baseline_profiles = [$(echo "${{ steps.config.outputs.baseline_profiles }}" | sed 's/,/","/g' | sed 's/^/"/' | sed 's/$/"/' | sed 's/""//')]
EOF
          
          # Copy baseline module
          cp -r ../baseline/* .
          
          echo "Generated terraform.tfvars:"
          cat terraform.tfvars
          
      - name: Terraform Init
        run: |
          cd baseline-deployment
          terraform init -backend-config="key=security-groups/baseline/${{ matrix.account }}/terraform.tfstate"
          
      - name: Terraform Plan
        id: plan
        run: |
          cd baseline-deployment
          terraform plan -var-file=terraform.tfvars -out=baseline-sync-plan
        continue-on-error: true
        
      - name: Terraform Apply
        id: apply
        if: steps.plan.outcome == 'success'
        run: |
          cd baseline-deployment
          terraform apply -auto-approve baseline-sync-plan
        continue-on-error: true
        
      - name: Capture outputs
        id: outputs
        if: steps.apply.outcome == 'success'
        run: |
          cd baseline-deployment
          terraform output -json > ../baseline-outputs-${{ matrix.account }}.json
          
          # Create summary of what was deployed
          echo "## Baseline Sync Results for Account ${{ matrix.account }}" > ../sync-summary-${{ matrix.account }}.md
          echo "" >> ../sync-summary-${{ matrix.account }}.md
          echo "**Changed Profiles**: ${{ needs.detect-changed-profiles.outputs.changed_profiles }}" >> ../sync-summary-${{ matrix.account }}.md
          echo "**Account Profiles**: ${{ steps.config.outputs.baseline_profiles }}" >> ../sync-summary-${{ matrix.account }}.md
          echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> ../sync-summary-${{ matrix.account }}.md
          echo "" >> ../sync-summary-${{ matrix.account }}.md
          echo "### Deployed Resources" >> ../sync-summary-${{ matrix.account }}.md
          
          # Extract security group information from outputs
          if [ -f ../baseline-outputs-${{ matrix.account }}.json ]; then
            python3 -c "
import json
import sys
try:
    with open('../baseline-outputs-${{ matrix.account }}.json', 'r') as f:
        outputs = json.load(f)
    
    enabled_profiles = outputs.get('enabled_baseline_profiles', {}).get('value', [])
    print(f'**Enabled Profiles**: {', '.join(enabled_profiles) if enabled_profiles else 'None'}')
    
    for key, value in outputs.items():
        if 'security_group_id' in key and value.get('value'):
            sg_id = value['value']
            sg_name = key.replace('_security_group_id', '').replace('_', '-')
            print(f'- **{sg_name}**: {sg_id}')
            
except Exception as e:
    print(f'Error parsing outputs: {e}', file=sys.stderr)
" >> ../sync-summary-${{ matrix.account }}.md
          fi
          
      - name: Upload sync results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ matrix.account }}
          path: |
            baseline-outputs-${{ matrix.account }}.json
            sync-summary-${{ matrix.account }}.md
          retention-days: 7
          
      - name: Report sync status
        if: always()
        run: |
          if [ "${{ steps.apply.outcome }}" = "success" ]; then
            echo "‚úÖ Baseline sync successful for account ${{ matrix.account }}"
          else
            echo "‚ùå Baseline sync failed for account ${{ matrix.account }}"
            if [ "${{ steps.plan.outcome }}" = "failure" ]; then
              echo "Failed at planning stage"
            elif [ "${{ steps.apply.outcome }}" = "failure" ]; then
              echo "Failed at apply stage"
            fi
            exit 1
          fi

  post-sync-summary:
    name: "Post-Sync Summary"
    runs-on: ubuntu-latest
    needs: [detect-changed-profiles, sync-baseline]
    if: always() && needs.detect-changed-profiles.outputs.changed_profiles != ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download all sync results
        uses: actions/download-artifact@v4
        with:
          pattern: sync-results-*
          merge-multiple: true
          
      - name: Create comprehensive summary
        run: |
          echo "# Baseline Security Groups Sync Summary (Opt-In)" > comprehensive-summary.md
          echo "" >> comprehensive-summary.md
          echo "**Trigger**: ${{ github.event_name }}" >> comprehensive-summary.md
          echo "**Commit**: ${{ github.sha }}" >> comprehensive-summary.md
          echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> comprehensive-summary.md
          echo "**Changed Profiles**: ${{ needs.detect-changed-profiles.outputs.changed_profiles }}" >> comprehensive-summary.md
          echo "**Target Accounts**: ${{ needs.detect-changed-profiles.outputs.affected_accounts }}" >> comprehensive-summary.md
          echo "" >> comprehensive-summary.md
          
          # Check if any accounts were affected
          if [ "${{ needs.detect-changed-profiles.outputs.affected_accounts }}" = "[]" ]; then
            echo "## No Accounts Affected" >> comprehensive-summary.md
            echo "" >> comprehensive-summary.md
            echo "No accounts have opted into the changed baseline profiles:" >> comprehensive-summary.md
            echo "- **Changed Profiles**: ${{ needs.detect-changed-profiles.outputs.changed_profiles }}" >> comprehensive-summary.md
            echo "" >> comprehensive-summary.md
            echo "‚ÑπÔ∏è **This is expected behavior** - baseline profiles are now opt-in per account." >> comprehensive-summary.md
            echo "To deploy these profiles to an account, add them to the \`baseline_profiles\` section" >> comprehensive-summary.md
            echo "in the account's \`security-groups.yaml\` file." >> comprehensive-summary.md
          else
            # Count successes and failures
            SUCCESS_COUNT=0
            FAILURE_COUNT=0
            
            echo "## Per-Account Results" >> comprehensive-summary.md
            echo "" >> comprehensive-summary.md
            
            IFS=',' read -ra ACCOUNTS <<< "${{ needs.detect-changed-profiles.outputs.affected_accounts }}"
            for account in "${ACCOUNTS[@]}"; do
              account=$(echo "$account" | tr -d '[]" ')
              if [ -f "sync-summary-${account}.md" ]; then
                echo "### ‚úÖ Account $account (Success)" >> comprehensive-summary.md
                cat "sync-summary-${account}.md" | tail -n +2 >> comprehensive-summary.md
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "### ‚ùå Account $account (Failed)" >> comprehensive-summary.md
                echo "Baseline sync failed for this account. Check workflow logs for details." >> comprehensive-summary.md
                FAILURE_COUNT=$((FAILURE_COUNT + 1))
              fi
              echo "" >> comprehensive-summary.md
            done
            
            # Add summary statistics
            echo "## Summary Statistics" >> comprehensive-summary.md
            echo "" >> comprehensive-summary.md
            echo "- **Successful**: $SUCCESS_COUNT accounts" >> comprehensive-summary.md
            echo "- **Failed**: $FAILURE_COUNT accounts" >> comprehensive-summary.md
            echo "- **Total**: $(($SUCCESS_COUNT + $FAILURE_COUNT)) accounts" >> comprehensive-summary.md
            
            if [ $FAILURE_COUNT -gt 0 ]; then
              echo "" >> comprehensive-summary.md
              echo "‚ö†Ô∏è **Action Required**: Some accounts failed to sync. Review the logs and consider manual intervention." >> comprehensive-summary.md
            fi
          fi
          
      - name: Post comprehensive summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('comprehensive-summary.md', 'utf8');
            
            if (context.eventName === 'push') {
              // Post as commit comment for push events
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: summary
              });
            } else {
              // For manual triggers, just log the summary
              console.log(summary);
            }

  handle-sync-failures:
    name: "Handle Sync Failures"
    runs-on: ubuntu-latest
    needs: [detect-changed-profiles, sync-baseline]
    if: always() && needs.sync-baseline.result == 'failure'
    
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Baseline Sync Failed (Opt-In) - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Baseline Sync Failure Report (Opt-In Model)
            
            **Trigger**: ${{ github.event_name }}
            **Commit**: \`${{ github.sha }}\`
            **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Changed Profiles**: \`${{ needs.detect-changed-profiles.outputs.changed_profiles }}\`
            **Affected Accounts**: \`${{ needs.detect-changed-profiles.outputs.affected_accounts }}\`
            
            ### What This Means
            
            The baseline security groups failed to sync to one or more accounts that have opted into the changed profiles.
            This could affect:
            - VPC endpoint access (vpc-endpoints profile)
            - Inter-service communication (eks-standard profile) 
            - WAF ‚Üí NLB traffic flow (internet-ingress profile)
            
            ### Immediate Actions Needed
            
            1. **Review workflow logs** for specific error messages
            2. **Check AWS permissions** for the deployment role
            3. **Verify account configuration** in \`accounts/<account_id>/security-groups.yaml\`
            4. **Check Terraform state** consistency
            5. **Consider manual baseline deployment** if critical
            
            ### Recovery Steps
            
            \`\`\`bash
            # Manual baseline deployment to failed account(s)
            cd baseline
            terraform init -backend-config="key=security-groups/baseline/ACCOUNT_ID/terraform.tfstate"
            terraform plan -var="account_id=ACCOUNT_ID" -var="baseline_profiles=[\"profile1\",\"profile2\"]"
            terraform apply
            \`\`\`
            
            ### About Opt-In Model
            
            ‚ÑπÔ∏è **Note**: Baseline profiles are now opt-in per account. Only accounts that have explicitly
            requested the changed profiles in their \`baseline_profiles\` configuration are affected.
            
            **Assigned to**: @security-team @platform-team
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['baseline-sync-failure', 'urgent', 'security-groups', 'infrastructure', 'opt-in-model'],
              assignees: ['security-team', 'platform-team']
            });

  cleanup:
    name: "Cleanup"
    runs-on: ubuntu-latest
    needs: [detect-changed-profiles, sync-baseline, post-sync-summary]
    if: always()
    
    steps:
      - name: Clean up
        run: |
          echo "Baseline sync workflow completed."
          echo "Changed profiles: ${{ needs.detect-changed-profiles.outputs.changed_profiles }}"
          echo "Affected accounts: ${{ needs.detect-changed-profiles.outputs.affected_accounts }}"
          echo "Temporary artifacts will be cleaned up automatically by retention policies."